use std
use bio

pkg xml =
	type eventiter = ctx

	type ctx = struct
		file	:	bio.file#
		owned	:	bool
		p	:	parser#
	;;

	type parser = struct
		buf	:	byte[:]
		bidx	:	std.size
		bcur	:	std.size
		line	:	std.size
		off	:	std.size
		state	:	state
		more	:	bool
	;;

	type event = union
		`Instruction	(byte[:], byte[:])	/* <?xml ... ?> */
		`Doctype	byte[:]			/* <!DOCTYPE ...> */
		`Eof					/* file end */
		`Start		(byte[:], (byte[:], byte[:])[:]) /* <foo> */
		`End		byte[:]			/* </foo> */
		`Characters	byte[:]			/* blah */
		`Cdata		byte[:]			/* <![CDATA[]]> */
		`Comment	byte[:]			/* <!-- --> */
	;;

	type mkerr = union
		`Efile		byte[:]	/* file open failed */
		`Eenc		byte[:]	/* file has unsupported encoding */
	;;

	type err = struct
		line	:	std.size
		off	:	std.size
		err	:	errtype
	;;

	type errtype = union
		`Empty			/* got nothing, needed something */
		`Inval		char	/* this char is invalid here */
		`Trunc		bio.err	/* parsing ended due to io err */
		`Unclosed	(byte[:], byte[:]) /* start with no end */
		`Unexpected	(char, char) /* read this, expected that */
	;;

	type state = union
		`Open
		`Close
		`Closing	byte[:]
	;;
;;
